---
- hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # This should be set via the command line at runtime.
    tag: ''
    build_dir: "{{ playbook_dir }}/../../build"


  pre_tasks:
    - include_vars: "{{ playbook_dir }}/vars.yaml"
      tags: always

    # - name: Verify none of the git submodules need updates.
    #   ansible.builtin.command: >
    #     git submodule update --recursive --remote
    #     chdir=../
    #   register: git_update
    #   failed_when: git_update.stdout != ''
    #   tags: build

    - name: Ensure the ~/.ansible directory exists.
      ansible.builtin.file:
        path: "{{ build_dir }}"
        state: directory
        mode: 0755
      tags: build

    - name: Ensure the ANSIBLE_GALAXY_TOKEN environment variable is set.
      ansible.builtin.fail:
        msg: ANSIBLE_GALAXY_TOKEN is not set.
      when: "lookup('env','ANSIBLE_GALAXY_TOKEN') == ''"
      no_log: true
      tags: deploy

    - name: Ensure the ~/.ansible directory exists.
      ansible.builtin.file:
        path: ~/.ansible
        state: directory
        mode: 0640
      tags: deploy

    - name: Write the Galaxy token to ~/.ansible/galaxy_token
      ansible.builtin.copy:
        content: |
          token: {{ lookup('env','ANSIBLE_GALAXY_TOKEN') }}
        dest: ~/.ansible/galaxy_token
        mode: 0640
      no_log: true
      tags: deploy

  tasks:
    - name: Template out the galaxy.yml file.
      ansible.builtin.template:
        src: galaxy.yml.j2
        dest: ../../galaxy.yml
        mode: 0644
      tags: build
      register: cfg

    - name: Build the collection.
      ansible.builtin.command: >
        ansible-galaxy collection build --output-path {{ build_dir }}
        chdir=../../
      tags: build

    - name: Update galaxy.yml
      ansible.builtin.command: >
        git config --global user.name "{{ git_user }}"
        git config --global user.email "{{ git_email }}"
        git add galaxy.yml && \
          git commit -m "Release {{ tag }}" && \
          git push
        chdir=../../
      tags: deploy
      when: cfg.changed

    - name: Publish the collection.
      ansible.builtin.command: >
        ansible-galaxy collection publish \
          {{ build_dir }}/{{ galaxy_namespace }}-{{ galaxy_name }}-{{ tag }}.tar.gz
        chdir=../
      tags: deploy
